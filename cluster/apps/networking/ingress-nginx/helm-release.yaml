---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: ingress-nginx
  namespace: networking
spec:
  chart:
    spec:
      chart: ingress-nginx
      sourceRef:
        kind: HelmRepository
        name: ingress-nginx-charts
      version: 3.20.1
  interval: 1h
  values:
    controller:
      replicaCount: 2
      containerPort:
        http: 80
        https: 443
      service:
        type: NodePort
        externalIPs:
          - ${SVC_NGINX_ADDR}
        externalTrafficPolicy: Local
      ingressClass: nginx
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/instance
                      operator: In
                      values:
                        - ingress-nginx
                    - key: app.kubernetes.io/component
                      operator: In
                      values:
                        - controller
                topologyKey: kubernetes.io/hostname
      config:
        proxy-body-size: '0'
        ssl-protocols: TLSv1.3 TLSv1.2
        global-auth-url: https://login.mgueye01.com/api/verify
        global-auth-signin: https://login.mgueye01.com
        global-auth-cache-key: $cookie_authelia_session
        hsts: false
        location-snippet: |
          add_header X-Frame-Options SAMEORIGIN always;
          add_header X-Content-Type-Options nosniff always;
          add_header X-XSS-Protection "1; mode=block" always;
      extraArgs:
        http-port: 9080
        https-port: 9443
        default-ssl-certificate: networking/${SECRET_DOMAIN/./-}-tls
      resources:
        requests:
          memory: 250Mi
          cpu: 25m
        limits:
          memory: 500Mi
    defaultBackend:
      enabled: false
